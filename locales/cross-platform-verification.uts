/**
 * è·¨å¹³å°å…¼å®¹æ€§éªŒè¯è„šæœ¬
 * éªŒè¯ i18n ç³»ç»Ÿåœ¨ä¸åŒå¹³å°ä¸Šçš„åŠŸèƒ½
 */

import { initI18n, isI18nInitialized, resetI18nInitialization } from './index.uts'
import { I18nManager } from '../composables/i18n/manager.uts'
import { LocaleLoader } from './loader.uts'

/**
 * éªŒè¯ç»“æœç±»å‹
 */
type VerificationResult = {
  testName: string
  passed: boolean
  message: string
  error?: any
}

/**
 * éªŒè¯æµ‹è¯•å¥—ä»¶
 */
class CrossPlatformVerification {
  private results: VerificationResult[] = []
  
  /**
   * è¿è¡Œæ‰€æœ‰éªŒè¯æµ‹è¯•
   */
  runAll(): void {
    console.log('='.repeat(60))
    console.log('å¼€å§‹è·¨å¹³å°å…¼å®¹æ€§éªŒè¯')
    console.log('='.repeat(60))
    console.log('')
    
    // é‡ç½®åˆå§‹åŒ–çŠ¶æ€
    resetI18nInitialization()
    
    // è¿è¡Œæµ‹è¯•
    this.testStaticImports()
    this.testLoaderSynchronous()
    this.testInitialization()
    this.testBasicTranslation()
    this.testLanguageSwitching()
    this.testFallbackMechanism()
    this.testParameterInterpolation()
    this.testLanguageRegistration()
    this.testAvailableLocales()
    this.testErrorHandling()
    
    // è¾“å‡ºç»“æœ
    this.printResults()
  }
  
  /**
   * æµ‹è¯•é™æ€å¯¼å…¥æ˜¯å¦æ­£å¸¸å·¥ä½œ
   */
  private testStaticImports(): void {
    try {
      const loader = LocaleLoader
      const zhCN = loader.loadLocale('zh-CN')
      const enUS = loader.loadLocale('en-US')
      const zhTW = loader.loadLocale('zh-TW')
      
      // éªŒè¯è¯­è¨€åŒ…ä¸ä¸ºç©º
      const zhCNValid = Object.keys(zhCN).length > 0
      const enUSValid = Object.keys(enUS).length > 0
      const zhTWValid = Object.keys(zhTW).length > 0
      
      if (zhCNValid && enUSValid && zhTWValid) {
        this.addResult({
          testName: 'é™æ€å¯¼å…¥éªŒè¯',
          passed: true,
          message: 'æ‰€æœ‰å†…ç½®è¯­è¨€åŒ…é™æ€å¯¼å…¥æˆåŠŸ'
        })
      } else {
        this.addResult({
          testName: 'é™æ€å¯¼å…¥éªŒè¯',
          passed: false,
          message: `è¯­è¨€åŒ…å¯¼å…¥å¤±è´¥: zh-CN=${zhCNValid}, en-US=${enUSValid}, zh-TW=${zhTWValid}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'é™æ€å¯¼å…¥éªŒè¯',
        passed: false,
        message: 'é™æ€å¯¼å…¥å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•åŠ è½½å™¨æ˜¯å¦ä¸ºåŒæ­¥æ–¹æ³•
   */
  private testLoaderSynchronous(): void {
    try {
      // è°ƒç”¨ loadLocale åº”è¯¥ç«‹å³è¿”å›ç»“æœï¼Œä¸æ˜¯ Promise
      const result = LocaleLoader.loadLocale('zh-CN')
      const isSync = typeof result === 'object' && result !== null
      
      if (isSync) {
        this.addResult({
          testName: 'åŠ è½½å™¨åŒæ­¥æ€§éªŒè¯',
          passed: true,
          message: 'LocaleLoader.loadLocale() æ˜¯åŒæ­¥æ–¹æ³•'
        })
      } else {
        this.addResult({
          testName: 'åŠ è½½å™¨åŒæ­¥æ€§éªŒè¯',
          passed: false,
          message: 'LocaleLoader.loadLocale() ä¸æ˜¯åŒæ­¥æ–¹æ³•'
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'åŠ è½½å™¨åŒæ­¥æ€§éªŒè¯',
        passed: false,
        message: 'åŠ è½½å™¨åŒæ­¥æ€§æµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•åˆå§‹åŒ–åŠŸèƒ½
   */
  private testInitialization(): void {
    try {
      // åˆå§‹åŒ–åº”è¯¥æ˜¯åŒæ­¥çš„
      initI18n()
      
      const initialized = isI18nInitialized()
      const manager = I18nManager.getInstance()
      const currentLocale = manager.getCurrentLocale()
      
      if (initialized && currentLocale === 'zh-CN') {
        this.addResult({
          testName: 'åˆå§‹åŒ–éªŒè¯',
          passed: true,
          message: 'I18n ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼Œé»˜è®¤è¯­è¨€ä¸º zh-CN'
        })
      } else {
        this.addResult({
          testName: 'åˆå§‹åŒ–éªŒè¯',
          passed: false,
          message: `åˆå§‹åŒ–çŠ¶æ€å¼‚å¸¸: initialized=${initialized}, locale=${currentLocale}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'åˆå§‹åŒ–éªŒè¯',
        passed: false,
        message: 'åˆå§‹åŒ–å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•åŸºæœ¬ç¿»è¯‘åŠŸèƒ½
   */
  private testBasicTranslation(): void {
    try {
      const manager = I18nManager.getInstance()
      
      // æµ‹è¯•ç®€ä½“ä¸­æ–‡ç¿»è¯‘
      const confirm = manager.translate('common.confirm')
      const cancel = manager.translate('common.cancel')
      const emptyTitle = manager.translate('empty.title')
      
      if (confirm === 'ç¡®å®š' && cancel === 'å–æ¶ˆ' && emptyTitle === 'æš‚æ— æ•°æ®') {
        this.addResult({
          testName: 'åŸºæœ¬ç¿»è¯‘åŠŸèƒ½',
          passed: true,
          message: 'ç¿»è¯‘åŠŸèƒ½æ­£å¸¸å·¥ä½œ'
        })
      } else {
        this.addResult({
          testName: 'åŸºæœ¬ç¿»è¯‘åŠŸèƒ½',
          passed: false,
          message: `ç¿»è¯‘ç»“æœä¸æ­£ç¡®: confirm=${confirm}, cancel=${cancel}, emptyTitle=${emptyTitle}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'åŸºæœ¬ç¿»è¯‘åŠŸèƒ½',
        passed: false,
        message: 'ç¿»è¯‘åŠŸèƒ½æµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•è¯­è¨€åˆ‡æ¢åŠŸèƒ½
   */
  private testLanguageSwitching(): void {
    try {
      const manager = I18nManager.getInstance()
      
      // åˆ‡æ¢åˆ°è‹±è¯­
      const switchSuccess = manager.setLocale('en-US')
      const confirm = manager.translate('common.confirm')
      const cancel = manager.translate('common.cancel')
      
      // åˆ‡æ¢å›ä¸­æ–‡
      manager.setLocale('zh-CN')
      
      if (switchSuccess && confirm === 'Confirm' && cancel === 'Cancel') {
        this.addResult({
          testName: 'è¯­è¨€åˆ‡æ¢åŠŸèƒ½',
          passed: true,
          message: 'è¯­è¨€åˆ‡æ¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ'
        })
      } else {
        this.addResult({
          testName: 'è¯­è¨€åˆ‡æ¢åŠŸèƒ½',
          passed: false,
          message: `è¯­è¨€åˆ‡æ¢å¤±è´¥: success=${switchSuccess}, confirm=${confirm}, cancel=${cancel}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'è¯­è¨€åˆ‡æ¢åŠŸèƒ½',
        passed: false,
        message: 'è¯­è¨€åˆ‡æ¢æµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•å›é€€æœºåˆ¶
   */
  private testFallbackMechanism(): void {
    try {
      const manager = I18nManager.getInstance()
      
      // æ³¨å†Œä¸€ä¸ªä¸å®Œæ•´çš„è¯­è¨€åŒ…
      manager.registerMessages('test-locale', {
        common: {
          confirm: 'Test Confirm'
          // ç¼ºå°‘ cancel é”®
        }
      })
      
      manager.setLocale('test-locale')
      
      const confirm = manager.translate('common.confirm')
      const cancel = manager.translate('common.cancel')  // åº”è¯¥å›é€€åˆ° zh-CN
      
      // åˆ‡æ¢å›ä¸­æ–‡
      manager.setLocale('zh-CN')
      
      if (confirm === 'Test Confirm' && cancel === 'å–æ¶ˆ') {
        this.addResult({
          testName: 'å›é€€æœºåˆ¶éªŒè¯',
          passed: true,
          message: 'å›é€€æœºåˆ¶æ­£å¸¸å·¥ä½œ'
        })
      } else {
        this.addResult({
          testName: 'å›é€€æœºåˆ¶éªŒè¯',
          passed: false,
          message: `å›é€€æœºåˆ¶å¼‚å¸¸: confirm=${confirm}, cancel=${cancel}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'å›é€€æœºåˆ¶éªŒè¯',
        passed: false,
        message: 'å›é€€æœºåˆ¶æµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•å‚æ•°æ’å€¼åŠŸèƒ½
   */
  private testParameterInterpolation(): void {
    try {
      const manager = I18nManager.getInstance()
      
      // æ³¨å†Œå¸¦å‚æ•°çš„ç¿»è¯‘
      manager.registerMessages('zh-CN', {
        test: {
          greeting: 'ä½ å¥½ï¼Œ{name}ï¼',
          count: 'å…±æœ‰ {count} ä¸ªé¡¹ç›®'
        }
      })
      
      const greeting = manager.translate('test.greeting', { name: 'å¼ ä¸‰' })
      const count = manager.translate('test.count', { count: 5 })
      
      if (greeting === 'ä½ å¥½ï¼Œå¼ ä¸‰ï¼' && count === 'å…±æœ‰ 5 ä¸ªé¡¹ç›®') {
        this.addResult({
          testName: 'å‚æ•°æ’å€¼åŠŸèƒ½',
          passed: true,
          message: 'å‚æ•°æ’å€¼åŠŸèƒ½æ­£å¸¸å·¥ä½œ'
        })
      } else {
        this.addResult({
          testName: 'å‚æ•°æ’å€¼åŠŸèƒ½',
          passed: false,
          message: `å‚æ•°æ’å€¼å¼‚å¸¸: greeting=${greeting}, count=${count}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'å‚æ•°æ’å€¼åŠŸèƒ½',
        passed: false,
        message: 'å‚æ•°æ’å€¼æµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•è¯­è¨€åŒ…æ³¨å†ŒåŠŸèƒ½
   */
  private testLanguageRegistration(): void {
    try {
      const manager = I18nManager.getInstance()
      
      // æ³¨å†Œæ–°è¯­è¨€åŒ…
      manager.registerMessages('ja-JP', {
        common: {
          confirm: 'ç¢ºèª',
          cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
        }
      })
      
      const hasJapanese = manager.hasLocale('ja-JP')
      
      if (hasJapanese) {
        manager.setLocale('ja-JP')
        const confirm = manager.translate('common.confirm')
        manager.setLocale('zh-CN')
        
        if (confirm === 'ç¢ºèª') {
          this.addResult({
            testName: 'è¯­è¨€åŒ…æ³¨å†ŒåŠŸèƒ½',
            passed: true,
            message: 'è¯­è¨€åŒ…æ³¨å†ŒåŠŸèƒ½æ­£å¸¸å·¥ä½œ'
          })
        } else {
          this.addResult({
            testName: 'è¯­è¨€åŒ…æ³¨å†ŒåŠŸèƒ½',
            passed: false,
            message: `æ³¨å†Œçš„è¯­è¨€åŒ…ç¿»è¯‘å¼‚å¸¸: confirm=${confirm}`
          })
        }
      } else {
        this.addResult({
          testName: 'è¯­è¨€åŒ…æ³¨å†ŒåŠŸèƒ½',
          passed: false,
          message: 'è¯­è¨€åŒ…æ³¨å†Œå¤±è´¥'
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'è¯­è¨€åŒ…æ³¨å†ŒåŠŸèƒ½',
        passed: false,
        message: 'è¯­è¨€åŒ…æ³¨å†Œæµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•å¯ç”¨è¯­è¨€åˆ—è¡¨
   */
  private testAvailableLocales(): void {
    try {
      const manager = I18nManager.getInstance()
      const availableLocales = manager.getAvailableLocales()
      const locales = availableLocales.value
      
      const hasZhCN = locales.includes('zh-CN')
      const hasEnUS = locales.includes('en-US')
      const hasZhTW = locales.includes('zh-TW')
      
      if (hasZhCN && hasEnUS && hasZhTW && locales.length >= 3) {
        this.addResult({
          testName: 'å¯ç”¨è¯­è¨€åˆ—è¡¨',
          passed: true,
          message: `å¯ç”¨è¯­è¨€åˆ—è¡¨æ­£å¸¸: ${locales.join(', ')}`
        })
      } else {
        this.addResult({
          testName: 'å¯ç”¨è¯­è¨€åˆ—è¡¨',
          passed: false,
          message: `å¯ç”¨è¯­è¨€åˆ—è¡¨å¼‚å¸¸: ${locales.join(', ')}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'å¯ç”¨è¯­è¨€åˆ—è¡¨',
        passed: false,
        message: 'å¯ç”¨è¯­è¨€åˆ—è¡¨æµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æµ‹è¯•é”™è¯¯å¤„ç†
   */
  private testErrorHandling(): void {
    try {
      const manager = I18nManager.getInstance()
      
      // æµ‹è¯•æ— æ•ˆè¯­è¨€ä»£ç 
      const invalidSwitch = manager.setLocale('invalid-locale')
      
      // æµ‹è¯•ä¸å­˜åœ¨çš„ç¿»è¯‘é”®
      const missingKey = manager.translate('nonexistent.key')
      
      if (!invalidSwitch && missingKey === 'nonexistent.key') {
        this.addResult({
          testName: 'é”™è¯¯å¤„ç†',
          passed: true,
          message: 'é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸å·¥ä½œ'
        })
      } else {
        this.addResult({
          testName: 'é”™è¯¯å¤„ç†',
          passed: false,
          message: `é”™è¯¯å¤„ç†å¼‚å¸¸: invalidSwitch=${invalidSwitch}, missingKey=${missingKey}`
        })
      }
    } catch (error) {
      this.addResult({
        testName: 'é”™è¯¯å¤„ç†',
        passed: false,
        message: 'é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥',
        error: error
      })
    }
  }
  
  /**
   * æ·»åŠ æµ‹è¯•ç»“æœ
   */
  private addResult(result: VerificationResult): void {
    this.results.push(result)
  }
  
  /**
   * æ‰“å°æµ‹è¯•ç»“æœ
   */
  private printResults(): void {
    console.log('')
    console.log('='.repeat(60))
    console.log('éªŒè¯ç»“æœæ±‡æ€»')
    console.log('='.repeat(60))
    console.log('')
    
    let passedCount = 0
    let failedCount = 0
    
    for (const result of this.results) {
      const status = result.passed ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'
      const icon = result.passed ? 'âœ“' : 'âœ—'
      
      console.log(`${icon} ${result.testName}`)
      console.log(`  ${result.message}`)
      
      if (result.error) {
        console.log(`  é”™è¯¯: ${result.error}`)
      }
      
      console.log('')
      
      if (result.passed) {
        passedCount++
      } else {
        failedCount++
      }
    }
    
    console.log('='.repeat(60))
    console.log(`æ€»è®¡: ${this.results.length} ä¸ªæµ‹è¯•`)
    console.log(`é€šè¿‡: ${passedCount} ä¸ª`)
    console.log(`å¤±è´¥: ${failedCount} ä¸ª`)
    console.log('='.repeat(60))
    
    if (failedCount === 0) {
      console.log('')
      console.log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è·¨å¹³å°å…¼å®¹æ€§éªŒè¯æˆåŠŸï¼')
      console.log('')
    } else {
      console.log('')
      console.log('âš ï¸  å­˜åœ¨å¤±è´¥çš„æµ‹è¯•ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯')
      console.log('')
    }
  }
}

/**
 * å¯¼å‡ºéªŒè¯å‡½æ•°
 */
export function runCrossPlatformVerification(): void {
  const verification = new CrossPlatformVerification()
  verification.runAll()
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œæ‰§è¡ŒéªŒè¯
// runCrossPlatformVerification()
