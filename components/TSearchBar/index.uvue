<script setup lang="uts">
import { ref, computed } from 'vue'
import type { TSearchBarProps } from './type.uts'
import { useI18n } from '../../composables/useI18n.uts'

/**
 * TSearchBar æœç´¢æ¡†ç»„ä»¶
 * @description ç”¨äºæœç´¢åœºæ™¯çš„è¾“å…¥æ¡†ç»„ä»¶ï¼Œæ”¯æŒé˜²æŠ–ã€æ¸…é™¤ã€å–æ¶ˆç­‰åŠŸèƒ½
 */

// Props å®šä¹‰ (ä» type.uts å¯¼å…¥ï¼Œæ’é™¤ modelValue)
type Props = Omit<TSearchBarProps, 'modelValue'>

const props = withDefaults(defineProps<Props>(), {
  shape: 'square',
  background: '#f5f5f5',
  maxlength: -1,
  clearable: true,
  showCancel: false,
  disabled: false,
  readonly: false,
  autoFocus: false,
  leftIcon: 'ğŸ”',
  debounce: 300,
  customClass: '',
  customStyle: ''
})

// ä½¿ç”¨ defineModel ç®¡ç†åŒå‘ç»‘å®š
const modelValue = defineModel<string>({ default: '' })

// Emits å®šä¹‰
const emit = defineEmits<{
  search: [value: string]
  input: [value: string]
  cancel: []
  clear: []
  focus: [event: Event]
  blur: [event: Event]
}>()

// ä½¿ç”¨ i18n
const { $t } = useI18n()

// ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¼ å…¥çš„å€¼ï¼Œå¦åˆ™ä½¿ç”¨ç¿»è¯‘
const displayPlaceholder = computed(() => {
  return props.placeholder !== undefined && props.placeholder !== '' 
    ? props.placeholder 
    : $t('searchBar.placeholder')
})

const displayCancelText = computed(() => {
  return props.cancelText !== undefined && props.cancelText !== '' 
    ? props.cancelText 
    : $t('searchBar.cancelText')
})

// çŠ¶æ€ç®¡ç†
const isFocused = ref<boolean>(false)
let debounceTimer: number | null = null

/**
 * è®¡ç®—å®¹å™¨ç±»å
 */
const containerClasses = computed((): string => {
  const classes: string[] = ['t-search-bar']

  if (props.shape === 'round') {
    classes.push('t-search-bar--round')
  }

  if (props.disabled) {
    classes.push('t-search-bar--disabled')
  }

  if (props.customClass) {
    classes.push(props.customClass)
  }

  return classes.join(' ')
})

/**
 * è®¡ç®—è¾“å…¥æ¡†æ ·å¼
 */
const inputStyle = computed((): string => {
  const styles: string[] = []

  styles.push(`background-color: ${props.background}`)

  if (props.customStyle) {
    styles.push(props.customStyle)
  }

  return styles.join('; ')
})

/**
 * è¾“å…¥äº‹ä»¶å¤„ç†ï¼ˆå¸¦é˜²æŠ–ï¼‰
 */
const handleInput = (event: any): void => {
  const value = event.detail.value as string
  modelValue.value = value
  emit('input', value)

  // é˜²æŠ–æœç´¢
  if (debounceTimer !== null) {
    clearTimeout(debounceTimer)
  }
  debounceTimer = setTimeout(() => {
    emit('search', value)
  }, props.debounce)
}

/**
 * èšç„¦äº‹ä»¶
 */
const handleFocus = (event: Event): void => {
  isFocused.value = true
  emit('focus', event)
}

/**
 * å¤±ç„¦äº‹ä»¶
 */
const handleBlur = (event: Event): void => {
  isFocused.value = false
  emit('blur', event)
}

/**
 * æ¸…ç©ºè¾“å…¥
 */
const handleClear = (): void => {
  modelValue.value = ''
  emit('clear')
  emit('search', '')
}

/**
 * ç‚¹å‡»æœç´¢æŒ‰é’®
 */
const handleSearch = (): void => {
  emit('search', modelValue.value)
}

/**
 * å–æ¶ˆæœç´¢
 */
const handleCancel = (): void => {
  modelValue.value = ''
  emit('cancel')
}
</script>

<template>
  <view :class="containerClasses">
    <view class="t-search-bar__content" :style="inputStyle">
      <!-- å·¦ä¾§å›¾æ ‡ -->
       <view v-if="leftIcon" name="icon">
         <text class="t-search-bar__icon">{{ leftIcon }}</text>
       </view>

      <!-- è¾“å…¥æ¡† -->
      <input
        class="t-search-bar__input"
        type="text"
        :value="modelValue"
        :placeholder="displayPlaceholder"
        :maxlength="maxlength"
        :disabled="disabled"
        :focus="autoFocus"
        @input="handleInput"
        @focus="handleFocus"
        @blur="handleBlur"
        @confirm="handleSearch"
      />

      <!-- æ¸…é™¤æŒ‰é’® -->
      <view
        v-if="clearable && modelValue.length > 0"
        class="t-search-bar__clear"
        @click="handleClear"
      >
        <text class="t-search-bar__clear-icon">âœ•</text>
      </view>
    </view>

    <!-- å–æ¶ˆæŒ‰é’® -->
    <text
      v-if="showCancel"
      class="t-search-bar__cancel"
      @click="handleCancel"
    >
      {{ displayCancelText }}
    </text>
  </view>
</template>

<style lang="scss" scoped>
.t-search-bar {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  flex-direction: row;

  &--round {
    .t-search-bar__content {
      border-radius: 18px;
    }
  }

  &--disabled {
    opacity: 0.6;
  }
}

.t-search-bar__content {
  position: relative;
  display: flex;
  flex-direction: row;
  align-items: center;
  flex: 1;
  padding: 8px 12px;
  background-color: #f5f5f5;
  border-radius: 4px;
}

.t-search-bar__icon {
  font-size: 16px;
  margin-right: 8px;
  color: #969799;
}

.t-search-bar__input {
  flex: 1;
  font-size: 14px;
  color: #323233;
  background-color: transparent;
  border: none;
  outline: none;
}

.t-search-bar__clear {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  margin-left: 8px;
  border-radius: 50%;
  background-color: #c8c9cc;
  cursor: pointer;
}

.t-search-bar__clear-icon {
  font-size: 10px;
  color: #fff;
}

.t-search-bar__cancel {
  padding-inline: 12px;
  font-size: 14px;
  color: #323233;
  cursor: pointer;
  white-space: nowrap;

  &:active {
    opacity: 0.7;
  }
}
</style>
