<template>
  <view class="page">
    <view class="header">
      <text class="title">å›½é™…åŒ–ç¤ºä¾‹ - è·¯å¾„æ–¹å¼æ³¨å†Œ</text>
      <text class="subtitle">æ¼”ç¤ºé€šè¿‡ä¼ å…¥ç›®å½•è·¯å¾„æ³¨å†Œæ–°è¯­è¨€</text>
    </view>
    
    <!-- è¯­è¨€åˆ‡æ¢åŒºåŸŸ -->
    <view class="section">
      <text class="section-title">é€‰æ‹©è¯­è¨€</text>
      <view class="lang-buttons">
        <view 
          v-for="lang in languages" 
          :key="lang.code"
          class="lang-button"
          :class="{ active: currentLang === lang.code }"
          @click="switchLanguage(lang.code)"
        >
          <text class="lang-text">{{ lang.label }}</text>
        </view>
      </view>
    </view>
    
    <!-- ç¿»è¯‘æ–‡æœ¬å±•ç¤º -->
    <view class="section">
      <text class="section-title">ç¿»è¯‘æ–‡æœ¬</text>
      <view class="translation-list">
        <view class="translation-item">
          <text class="key">common.confirm</text>
          <text class="value">{{ $t('common.confirm') }}</text>
        </view>
        <view class="translation-item">
          <text class="key">common.cancel</text>
          <text class="value">{{ $t('common.cancel') }}</text>
        </view>
        <view class="translation-item">
          <text class="key">empty.noData</text>
          <text class="value">{{ $t('empty.noData') }}</text>
        </view>
        <view class="translation-item">
          <text class="key">loading.text</text>
          <text class="value">{{ $t('loading.text') }}</text>
        </view>
      </view>
    </view>
    
    <!-- è·¯å¾„æ³¨å†Œè¯´æ˜ -->
    <view class="section">
      <text class="section-title">è·¯å¾„æ–¹å¼æ³¨å†Œ</text>
      
      <view class="info-box">
        <text class="info-text">ä½¿ç”¨è·¯å¾„æ–¹å¼æ³¨å†Œæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰è¯­è¨€åŒ…æ–‡ä»¶ï¼š</text>
        <text class="info-text">â€¢ common.json</text>
        <text class="info-text">â€¢ form.json</text>
        <text class="info-text">â€¢ input.json</text>
        <text class="info-text">â€¢ dialog.json</text>
        <text class="info-text">â€¢ empty.json</text>
        <text class="info-text">â€¢ loading.json</text>
      </view>

      <!-- #ifndef MP -->
      <view class="code-block">
        <text class="code-text">// æ³¨å†Œæ—¥è¯­è¯­è¨€åŒ…ï¼ˆå¼‚æ­¥æ–¹å¼ï¼‰</text>
        <text class="code-text">await i18nManager.registerLocaleAsync(</text>
        <text class="code-text">  'ja-JP',</text>
        <text class="code-text">  '/pages/i18n-demo/locales/ja-JP'</text>
        <text class="code-text">)</text>
      </view>
      <!-- #endif -->
      <!-- #ifdef MP -->
      <view class="code-block">
        <text class="code-text">ä»£ç ç¤ºä¾‹è¯·æŸ¥çœ‹æºç </text>
      </view>
      <!-- #endif -->
      
      <view class="button-group">
        <view class="custom-button" @click="registerJapanese">
          <text class="button-text">æ³¨å†Œæ—¥è¯­</text>
        </view>
        <view class="custom-button secondary" @click="registerKorean">
          <text class="button-text">æ³¨å†ŒéŸ©è¯­</text>
        </view>
        <view class="custom-button info" @click="showPathInfo">
          <text class="button-text">æŸ¥çœ‹ç»“æ„</text>
        </view>
      </view>
    </view>

    <!-- æ–‡ä»¶ç»“æ„å±•ç¤º -->
    <!-- #ifndef MP -->
    <view class="section" v-if="showStructure">
      <text class="section-title">è¯­è¨€åŒ…ç›®å½•ç»“æ„</text>
      <view class="file-tree">
        <text class="tree-item">pages/i18n-demo/locales/</text>
        <text class="tree-item indent1">â”œâ”€â”€ ja-JP/</text>
        <text class="tree-item indent2">â”‚   â”œâ”€â”€ common.json</text>
        <text class="tree-item indent2">â”‚   â”œâ”€â”€ form.json</text>
        <text class="tree-item indent2">â”‚   â”œâ”€â”€ input.json</text>
        <text class="tree-item indent2">â”‚   â”œâ”€â”€ dialog.json</text>
        <text class="tree-item indent2">â”‚   â”œâ”€â”€ empty.json</text>
        <text class="tree-item indent2">â”‚   â””â”€â”€ loading.json</text>
        <text class="tree-item indent1">â””â”€â”€ ko-KR/</text>
        <text class="tree-item indent2">    â”œâ”€â”€ common.json</text>
        <text class="tree-item indent2">    â”œâ”€â”€ form.json</text>
        <text class="tree-item indent2">    â”œâ”€â”€ input.json</text>
        <text class="tree-item indent2">    â”œâ”€â”€ dialog.json</text>
        <text class="tree-item indent2">    â”œâ”€â”€ empty.json</text>
        <text class="tree-item indent2">    â””â”€â”€ loading.json</text>
      </view>
    </view>
    <!-- #endif -->
    
    <!-- å·²åŠ è½½çš„æ¨¡å— -->
    <view class="section">
      <text class="section-title">å½“å‰è¯­è¨€å·²åŠ è½½çš„æ¨¡å—</text>
      <view class="module-list">
        <view v-for="module in loadedModules" :key="module" class="module-item">
          <text class="module-icon">ğŸ“¦</text>
          <text class="module-name">{{ module }}</text>
        </view>
      </view>
    </view>
    
    <!-- å¯ç”¨è¯­è¨€åˆ—è¡¨ -->
    <view class="section">
      <text class="section-title">å·²æ³¨å†Œçš„è¯­è¨€</text>
      <view class="locale-list">
        <view v-for="locale in availableLocales" :key="locale" class="locale-item">
          <text class="locale-code">{{ locale }}</text>
          <text class="locale-name">{{ getLocaleName(locale) }}</text>
          <text class="locale-badge">è·¯å¾„åŠ è½½</text>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup lang="uts">
import { ref, computed } from 'vue'
import { useI18n } from '@/composables/useI18n.uts'
import { I18nManager } from '@/composables/i18n/manager.uts'

const { $t } = useI18n()
const i18nManager = I18nManager.getInstance()

// å½“å‰è¯­è¨€
const currentLang = ref<string>(i18nManager.getLocale())

// æ˜¯å¦æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
const showStructure = ref<boolean>(false)

// å†…ç½®è¯­è¨€åˆ—è¡¨ï¼ˆä½¿ç”¨ ref ä½¿å…¶å¯å˜ï¼‰
const languages = ref([
  { code: 'zh-CN', label: 'ç®€ä½“ä¸­æ–‡' },
  { code: 'zh-TW', label: 'ç¹é«”ä¸­æ–‡' },
  { code: 'en-US', label: 'English' }
])

// å·²åŠ è½½çš„æ¨¡å—åˆ—è¡¨ï¼ˆç¤ºä¾‹ä¸­å®é™…åŠ è½½çš„æ¨¡å—ï¼‰
const loadedModules = [
  'common',
  'form',
  'input',
  'dialog',
  'empty',
  'loading'
]

// å¯ç”¨è¯­è¨€åˆ—è¡¨ï¼ˆå“åº”å¼ï¼‰
const availableLocales = computed<string[]>(() => {
  return i18nManager.getAvailableLocales().value
})

// åˆ‡æ¢è¯­è¨€
const switchLanguage = (locale: string): void => {
  if (i18nManager.setLocale(locale)) {
    currentLang.value = locale
    uni.showToast({
      title: `å·²åˆ‡æ¢åˆ° ${getLocaleName(locale)}`,
      icon: 'success'
    })
  } else {
    uni.showToast({
      title: 'è¯­è¨€åŒ…æœªæ³¨å†Œ',
      icon: 'error'
    })
  }
}

// æ³¨å†Œæ—¥è¯­è¯­è¨€åŒ…ï¼ˆè·¯å¾„æ–¹å¼ï¼‰
const registerJapanese = async (): Promise<void> => {
  try {
    // æ˜¾ç¤ºåŠ è½½æç¤º
    uni.showLoading({
      title: 'åŠ è½½ä¸­...'
    })
    
    // ä½¿ç”¨å¼‚æ­¥è·¯å¾„æ–¹å¼æ³¨å†Œ
    await i18nManager.registerLocaleAsync('ja-JP', '/pages/i18n-demo/locales/ja-JP')
    
    // æ·»åŠ åˆ°è¯­è¨€åˆ—è¡¨
    if (!languages.value.some(lang => lang.code === 'ja-JP')) {
      languages.value.push({ code: 'ja-JP', label: 'æ—¥æœ¬èª' })
    }
    
    uni.hideLoading()
    uni.showToast({
      title: 'æ—¥è¯­è¯­è¨€åŒ…æ³¨å†ŒæˆåŠŸ',
      icon: 'success'
    })
  } catch (e) {
    uni.hideLoading()
    uni.showToast({
      title: 'æ³¨å†Œå¤±è´¥',
      icon: 'error'
    })
    console.error('æ³¨å†Œæ—¥è¯­å¤±è´¥:', e)
  }
}

// æ³¨å†ŒéŸ©è¯­è¯­è¨€åŒ…ï¼ˆè·¯å¾„æ–¹å¼ï¼‰
const registerKorean = async (): Promise<void> => {
  try {
    // æ˜¾ç¤ºåŠ è½½æç¤º
    uni.showLoading({
      title: 'åŠ è½½ä¸­...'
    })
    
    // ä½¿ç”¨å¼‚æ­¥è·¯å¾„æ–¹å¼æ³¨å†Œ
    await i18nManager.registerLocaleAsync('ko-KR', '/pages/i18n-demo/locales/ko-KR')
    
    // æ·»åŠ åˆ°è¯­è¨€åˆ—è¡¨
    if (!languages.value.some(lang => lang.code === 'ko-KR')) {
      languages.value.push({ code: 'ko-KR', label: 'í•œêµ­ì–´' })
    }
    
    uni.hideLoading()
    uni.showToast({
      title: 'éŸ©è¯­è¯­è¨€åŒ…æ³¨å†ŒæˆåŠŸ',
      icon: 'success'
    })
  } catch (e) {
    uni.hideLoading()
    uni.showToast({
      title: 'æ³¨å†Œå¤±è´¥',
      icon: 'error'
    })
    console.error('æ³¨å†ŒéŸ©è¯­å¤±è´¥:', e)
  }
}

// æ˜¾ç¤ºè·¯å¾„ä¿¡æ¯
const showPathInfo = (): void => {
  showStructure.value = !showStructure.value
}

// è·å–è¯­è¨€åç§°
const getLocaleName = (locale: string): string => {
  const names: Record<string, string> = {
    'zh-CN': 'ç®€ä½“ä¸­æ–‡',
    'zh-TW': 'ç¹é«”ä¸­æ–‡',
    'en-US': 'English',
    'ja-JP': 'æ—¥æœ¬èª',
    'ko-KR': 'í•œêµ­ì–´'
  }
  return names[locale] || locale
}
</script>

<style lang="scss" scoped>
.page {
  min-height: 100vh;
  background-color: #f5f5f5;
  padding: 32rpx;
}

.header {
  margin-bottom: 48rpx;
  
  .title {
    font-size: 48rpx;
    font-weight: bold;
    color: #333;
    display: block;
    margin-bottom: 16rpx;
  }
  
  .subtitle {
    font-size: 28rpx;
    color: #666;
    display: block;
  }
}

.section {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 32rpx;
  
  .section-title {
    font-size: 32rpx;
    font-weight: bold;
    color: #333;
    display: block;
    margin-bottom: 24rpx;
  }
}

.lang-buttons {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 16rpx;
}

.lang-button {
  flex: 1;
  min-width: 200rpx;
  height: 80rpx;
  background-color: #f0f0f0;
  border-radius: 12rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  
  &.active {
    background-color: #1890ff;
    
    .lang-text {
      color: #fff;
    }
  }
  
  .lang-text {
    font-size: 28rpx;
    color: #333;
  }
}

.translation-list {
  display: flex;
  flex-direction: column;
  gap: 16rpx;
}

.translation-item {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  padding: 24rpx;
  background-color: #f9f9f9;
  border-radius: 12rpx;
  
  .key {
    font-size: 26rpx;
    color: #666;
    font-family: monospace;
  }
  
  .value {
    font-size: 28rpx;
    color: #333;
    font-weight: 500;
  }
}

.warning-box {
  background-color: #fff7e6;
  border-left: 4rpx solid #faad14;
  padding: 24rpx;
  border-radius: 8rpx;
  margin-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  gap: 16rpx;
  
  .warning-icon {
    font-size: 32rpx;
  }
  
  .warning-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8rpx;
  }
  
  .warning-title {
    font-size: 28rpx;
    color: #d46b08;
    font-weight: bold;
    display: block;
  }
  
  .warning-text {
    font-size: 24rpx;
    color: #ad6800;
    display: block;
    line-height: 36rpx;
  }
}

.info-box {
  background-color: #e6f7ff;
  border-left: 4rpx solid #1890ff;
  padding: 24rpx;
  border-radius: 8rpx;
  margin-bottom: 24rpx;
  
  .info-text {
    font-size: 26rpx;
    color: #333;
    display: block;
    line-height: 40rpx;
  }
}

.code-block {
  background-color: #282c34;
  border-radius: 12rpx;
  padding: 24rpx;
  margin-bottom: 24rpx;
  
  .code-text {
    font-size: 24rpx;
    color: #abb2bf;
    font-family: monospace;
    display: block;
    line-height: 40rpx;
  }
}

.button-group {
  display: flex;
  flex-direction: row;
  gap: 16rpx;
}

.custom-button {
  flex: 1;
  height: 80rpx;
  background-color: #1890ff;
  border-radius: 12rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  
  &.secondary {
    background-color: #52c41a;
  }
  
  &.info {
    background-color: #faad14;
  }
  
  .button-text {
    font-size: 28rpx;
    color: #fff;
    font-weight: 500;
  }
}

.file-tree {
  background-color: #f9f9f9;
  border-radius: 12rpx;
  padding: 24rpx;
  
  .tree-item {
    font-size: 26rpx;
    color: #333;
    font-family: monospace;
    display: block;
    line-height: 44rpx;
    
    &.indent1 {
      padding-left: 32rpx;
    }
    
    &.indent2 {
      padding-left: 64rpx;
    }
  }
}

.module-list {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 16rpx;
}

.module-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 12rpx;
  padding: 16rpx 24rpx;
  background-color: #f0f0f0;
  border-radius: 8rpx;
  
  .module-icon {
    font-size: 28rpx;
  }
  
  .module-name {
    font-size: 26rpx;
    color: #333;
    font-family: monospace;
  }
}

.locale-list {
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.locale-item {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx 24rpx;
  background-color: #f9f9f9;
  border-radius: 12rpx;
  
  .locale-code {
    font-size: 26rpx;
    color: #1890ff;
    font-family: monospace;
    font-weight: 500;
  }
  
  .locale-name {
    font-size: 28rpx;
    color: #333;
    flex: 1;
    margin-left: 24rpx;
  }
  
  .locale-badge {
    font-size: 22rpx;
    color: #52c41a;
    background-color: #f6ffed;
    border: 1rpx solid #b7eb8f;
    padding: 4rpx 12rpx;
    border-radius: 4rpx;
  }
}
</style>
